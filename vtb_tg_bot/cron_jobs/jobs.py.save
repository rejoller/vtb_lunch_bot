import os
import requests
import pytesseract
from PIL import Image
from sqlalchemy.dialects.postgresql import insert
from sqlalchemy.ext.asyncio import AsyncSession
from database.models import Menu_review

from datetime import datetime as dt
import logging
from bot import bot



openai_api_key = os.getenv('openai_api_key')

url = 'https://freshvote.ru/menu/000000035.jpg'

pytesseract.pytesseract.tesseract_cmd = "/usr/bin/tesseract"

save_dir = 'menu_path'  

t = str(dt.now()).replace('-','').replace(' ','').replace(':','').replace('.','')

filename = url.split('/')[-1]
filename = t + '_'+ filename

filepath = os.path.join(save_dir, filename)


resp = requests.get(url)
   
def teseract_recognition(path_img):
    return pytesseract.image_to_string(Image.open(path_img), lang='rus+eng', config=r'--oem 3 --psm 6') 


async def get_menu(session: AsyncSession):
    with open(filepath, 'wb') as f:
        f.write(resp.content)
        
        response_tesseract = teseract_recognition(filepath)
        
        from openai import OpenAI
        client = OpenAI(api_key=openai_api_key)

        gpt_response = client.responses.create(
            model="gpt-5",
            input=f"""ты помощник по составлению краткого меню для категории бизнес ланчей за 305 рублей в таком стиле, вот примеры, :
            [1. Коллеги ну а сегодня 3 декабря среда, с чем я вас и поздравляю\n
            На гарнир у нас булгур или вареная картошка, а салаты либо с крабовыми палочками либо с пекинской капустой.
            А вот супы максимально удручают, <b>уха</b> или <b>рассольник с перловкой</b>
                
            2. Итак сегодня 2 декабря у нас на гарнир <b>гречка</b> и <b>пюре</b>. Салаты и супы тоже вполне солидные
            ]
            
                , напиши меню на основе этого распозннаного изображения (могут быть неточности так как изображение прогонялось через библиотеку tesseracrt)
                используя разметку HTML для телеграм и добавляй еще немного смайлов. Также в конце пиши еще что в ланчах которые на других уровнях - лайт и
                еще какой то там есть я не помню: {response_tesseract}"""
        )
        review_text = gpt_response.output_text
        if review_text:
            query = insert(Menu_review).values(dttm=dt.now(), review_text=str(review_text))
		#-4897200857

	    await bot.send_message(chat_id = '964635576', text = review_text) 
            await session.execute(query)
            await session.commit()
        else:
            logging.info('Не удалось получить меню')
 
